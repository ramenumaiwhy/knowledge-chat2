# 🏗️ システムアーキテクチャと動作フロー

## 📊 システム全体図

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    USER     │     │  LINE API   │     │   Railway   │
│  (LINEアプリ) │────▶│  (Webhook)  │────▶│    (n8n)    │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                                │
                    ┌───────────────────────────┼───────────────┐
                    │                           │               │
                    ▼                           ▼               ▼
            ┌─────────────┐            ┌─────────────┐ ┌─────────────┐
            │   GitHub    │            │ Gemini API  │ │ NotebookLM  │
            │ (CSV保管庫)  │            │  (AI頭脳)   │ │ (知識整理)  │
            └─────────────┘            └─────────────┘ └─────────────┘
```

## 🔄 動作の流れ（詳細）

### 1️⃣ ユーザーがLINEでメッセージを送信
```
ユーザー: 「料金プランを教えて」
    ↓
LINE API: メッセージをWebhook形式でn8nに送信
```

### 2️⃣ n8nがメッセージを受信・処理
```javascript
// n8nの処理フロー
1. Webhook受信
   - メッセージ内容を取得
   - 返信用トークンを保存

2. GitHubからCSVデータを取得
   - knowledge.csvをダウンロード
   - Base64デコード

3. キーワード検索
   - 「料金」「プラン」でCSVを検索
   - 関連する行を抽出
```

### 3️⃣ Gemini APIで自然な回答を生成
```javascript
// 送信するプロンプト例
"あなたは親切なサポートです。
ユーザーの質問: 料金プランを教えて
関連情報:
- 基本プラン: 月額1000円...
- プレミアムプラン: 月額3000円...

簡潔に答えてください。"
```

### 4️⃣ LINEに返信
```
n8n → LINE API: 生成された回答を送信
    ↓
ユーザー: 「基本プランは月額1000円、プレミアムプランは月額3000円です。」
```

## 🔐 セキュリティ設定の説明

### N8N_ENCRYPTION_KEY とは？
- **役割**: n8nが認証情報（APIキーなど）を暗号化して保存するための鍵
- **なぜ必要？**: GitHubトークンやLINEトークンを安全に保管するため
- **生成方法**: 
  ```bash
  openssl rand -hex 32
  ```
  これで64文字のランダムな文字列が生成される

### N8N_BASIC_AUTH_PASSWORD とは？
- **役割**: n8nの管理画面にアクセスするためのパスワード
- **なぜ必要？**: 誰でもワークフローを変更できないようにするため
- **設定例**: `SuperSecurePassword123!`

## 📁 各コンポーネントの役割

### 1. **Railway** (ホスティング)
- n8nコンテナを24時間稼働
- 月額$5で安定運用
- 自動デプロイ対応

### 2. **n8n** (ワークフロー)
- ノーコードで処理フローを構築
- エラーハンドリング
- 実行ログの記録

### 3. **GitHub** (データ管理)
- CSVファイルのバージョン管理
- 自動マージ機能
- 更新履歴の追跡

### 4. **Gemini API** (AI処理)
- 自然言語での回答生成
- 文脈を理解した応答
- 無料枠: 60回/分

### 5. **NotebookLM** (知識整理)
- CSVデータを構造化
- 重要な洞察を発見
- 手動で月1回更新

## 🚀 データ更新の流れ

```
1. updates.csvに新データ追加
    ↓
2. GitHubにプッシュ
    ↓
3. GitHub Actionsが自動起動
    ↓
4. CSVマージスクリプト実行
    ↓
5. knowledge.csvが更新される
    ↓
6. 次回の質問から新データが反映
```

## 💡 コスト最適化のポイント

1. **Gemini API**: 無料枠（60 QPM）を活用
2. **Railway**: Hobbyプラン（$5/月）で十分
3. **GitHub**: 無料プランで問題なし
4. **NotebookLM**: 完全無料
5. **LINE API**: 無料

**合計: 月額$5のみ！**

## 🔧 カスタマイズ例

### 画像対応
```javascript
// n8nワークフローに追加
if (messageType === 'image') {
  // Gemini Vision APIを呼び出し
  // 画像を解析して回答
}
```

### 多言語対応
```csv
id,category,question,answer,keywords,source,language,updated_at
1,"料金","How much?","$10/month","price,cost","docs","en","2024-01-15"
```

### 回答の精度向上
- NotebookLMで定期的に知識を整理
- よくある質問をCSVに追加
- Geminiのプロンプトを調整